#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π applications..."
echo "================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã applications
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã applications..."

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É
TABLE_EXISTS=$(php artisan tinker --execute="echo Schema::hasTable('applications') ? 'YES' : 'NO';")

if [[ $TABLE_EXISTS == *"YES"* ]]; then
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ applications —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    
    # –û—Ç–º–µ—á–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
    echo "2. –û—Ç–º–µ—Ç–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ applications –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π..."
    php artisan migrate:fake-batch --file=2025_08_20_141213_create_applications_table.php
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
        exit 1
    fi
    
else
    echo "‚ÑπÔ∏è  –¢–∞–±–ª–∏—Ü–∞ applications –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –º–∏–≥—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
echo ""
echo "3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π..."
php artisan migrate --force

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
    echo ""
    echo "üìä –ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:"
    php artisan migrate:status
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å: ./deploy-migration-fix.sh"
    exit 1
fi

echo ""
echo "üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!"
